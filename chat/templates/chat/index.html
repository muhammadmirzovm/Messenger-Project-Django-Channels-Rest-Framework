<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Rooms</title>
</head>
<body>
  {% if user.is_authenticated %}
    <p>Hello, <b>{{ user.username }}</b> — <a href="{% url 'logout' %}">Logout</a></p>
  {% else %}
    <p><a href="{% url 'login' %}">Login</a> | <a href="{% url 'signup' %}">Sign up</a></p>
  {% endif %}

  <h3>Create or join a room</h3>
  <form method="post">{% csrf_token %}
    <input name="name" type="text" placeholder="Room name">
    <button type="submit">Enter</button>
  </form>

  <h3>Rooms</h3>
  <ul>
    {% for r in rooms %}
      <li><a href="{% url 'room' r.pk %}">{{ r.name }}</a></li>
    {% empty %}
      <li>No rooms yet</li>
    {% endfor %}
  </ul>

  <!-- All Online Users -->
  <h3>All online users</h3>
  <ul id="online-users"><li>Loading…</li></ul>

  <script>
    (function(){
      // ✅ Keep the raw template valid JS for the editor:
      const IS_AUTH = '{{ user.is_authenticated|yesno:"true,false" }}' === 'true';

      if (!IS_AUTH) {
        document.getElementById("online-users").innerHTML = "<li>Login to see online users</li>";
        return;
      }

      const wsURL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/presence/";
      const sock = new WebSocket(wsURL);
      let every = 20, timer = null;

      function renderFromAPI(){
        fetch("/api/online/")
          .then(r=>r.json())
          .then(d=>{
            const list = (d.online || []).map(u=>`<li>${u.username}</li>`).join("");
            document.getElementById("online-users").innerHTML = list || "<li>No one online yet</li>";
          })
          .catch(()=>{
            document.getElementById("online-users").innerHTML = "<li>(offline)</li>";
          });
      }

      function startHB(){
        if (timer) clearInterval(timer);
        timer = setInterval(function(){
          if (sock.readyState === 1) sock.send(JSON.stringify({type:"heartbeat"}));
        }, every * 1000);
      }

      sock.onmessage = function(e){
        const msg = JSON.parse(e.data);
        if (msg.type === "all_online"){
          every = msg.heartbeat_every || every;
          startHB();
          renderFromAPI();
        } else if (msg.type === "presence_event"){
          renderFromAPI();
        }
      };

      sock.onclose = function(){ if (timer) clearInterval(timer); };
    })();
  </script>
</body>
</html>
