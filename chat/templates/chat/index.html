<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Rooms</title>
  <style>
    :root{
      --bg:#f2f5f7; --panel:#ffffff; --text:#0f1419; --muted:#5b6b79; --border:#e6ecf1;
      --blue:#3390ec; --blue-weak:#e6f3ff; --success:#3cb179; --radius:16px; --shadow:0 8px 24px rgba(15,20,25,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e1621; --panel:#17212b; --text:#e9eef3; --muted:#a3b1bf; --border:#253341;
        --blue:#50a7ea; --blue-weak:#1d2a36; --success:#4dd09e; --shadow:none;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    a{color:var(--blue);text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{display:inline-block;min-width:1.5em;padding:2px 8px;margin-left:8px;font-size:12px;line-height:1;border-radius:999px;background:var(--blue-weak);color:var(--blue);border:1px solid var(--border)}

    .app{height:100vh;display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px}
    .sidebar,.main{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
    .sb-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
    .avatar{width:32px;height:32px;border-radius:50%;background:var(--blue);color:#fff;display:grid;place-items:center;font-weight:700}
    .greet{font-weight:600}
    .search{padding:12px 16px;border-bottom:1px solid var(--border)}
    .search input,.room-form input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .room-form{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--blue);background:var(--blue);color:#fff;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .rooms{list-style:none;margin:0;padding:0;overflow:auto}
    .rooms li{border-bottom:1px solid var(--border)}
    .room-item{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .room-item:hover{background:var(--blue-weak)}
    .rname{font-weight:600}
    .chip{font-size:12px;color:var(--muted)}

    .main-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .main-body{flex:1;overflow:auto;padding:24px;display:grid;grid-template-columns:1fr 320px;gap:16px}
    /* ==== BIG CREATIVE HERO ==== */
.hero {
  position: relative; overflow: hidden; color: #fff;
  border-radius: 28px; box-shadow: var(--shadow);
  padding: clamp(28px, 4vw, 56px);
  min-height: clamp(420px, 58vh, 640px);
  display: grid; grid-template-columns: 1.1fr .9fr; align-items: center; gap: clamp(16px, 3vw, 40px);
  background:
    radial-gradient(1200px 600px at -10% -10%, rgba(255,255,255,.14), transparent 60%),
    radial-gradient(900px 500px at 120% 120%, rgba(255,255,255,.10), transparent 60%),
    linear-gradient(135deg, var(--blue) 0%, #7bc4ff 100%);
}
.hero::before{
  content:""; position:absolute; inset:-25%;
  background: conic-gradient(from 0turn, rgba(255,255,255,.18), rgba(255,255,255,0) 30%, rgba(255,255,255,.18) 60%, rgba(255,255,255,0) 100%);
  filter: blur(70px); transform: rotate(8deg);
  animation: heroSpin 20s linear infinite; pointer-events: none;
}
@keyframes heroSpin { to { transform: rotate(368deg); } }

.hero-title{ margin:0 0 8px; font-weight: 900; letter-spacing:.2px; line-height:1.05;
  font-size: clamp(36px, 5vw, 64px);
}
.hero-subtitle{ margin:0 0 18px; font-size: clamp(14px, 1.7vw, 18px); opacity:.98; max-width: 60ch; }
.hero-cta{ display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center; }
.hero-btn{ background: rgba(255,255,255,.18); border-color: transparent; backdrop-filter: blur(6px); }
.btn.ghost{ background: transparent; color: #fff; border:1px solid rgba(255,255,255,.6); }
.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; font-size:12px;
  background: rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25);
}

/* Art: rotating ring + phone mock + floating clouds */
.hero-art{ position: relative; min-height: 320px; }
.ring{
  position:absolute; inset:-40% -20% auto auto; aspect-ratio:1/1; width: 520px;
  border-radius: 50%;
  background: conic-gradient(from 0turn, rgba(255,255,255,.0), rgba(255,255,255,.25), rgba(255,255,255,.0));
  filter: blur(10px); opacity:.55; animation: ringSpin 28s linear infinite;
}
@keyframes ringSpin { to { transform: rotate(360deg); } }

.phone{
  position: absolute; right: clamp(0px, 1vw, 16px); top: 6%;
  width: clamp(240px, 26vw, 320px); height: clamp(420px, 52vh, 560px);
  border-radius: 30px; padding: 14px;
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.35);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  transform: perspective(1200px) rotateY(-14deg) rotateX(4deg);
  backdrop-filter: blur(8px);
  animation: float 9s ease-in-out infinite;
}
.statusbar{
  height: 16px; border-radius: 999px; background: rgba(255,255,255,.35); margin-bottom: 12px;
}
.screen{
  height: calc(100% - 28px); border-radius: 22px; padding: 14px 12px;
  background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.28);
  display:flex; flex-direction:column; gap:8px; overflow:hidden;
}
.bubble{
  max-width: 75%; padding: 10px 12px; border-radius: 14px; font-size: 13px; line-height:1.35;
  background: #ffffff; color: #0f1419; border: 1px solid rgba(15,20,25,.08);
}
.me{ margin-left: auto; background: #dbf5ff; border-color: transparent; }
.them{ margin-right: auto; }
@media (prefers-color-scheme: dark){
  .bubble.them{ background:#1a232d; color:#e9eef3; border-color: #253341; }
  .bubble.me{ background:#1f3d52; color:#e9eef3; }
}

.cloud{
  position:absolute; border-radius: 18px; filter: blur(.3px);
  background: rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.28);
  width: 140px; height: 86px; animation: float 7.5s ease-in-out infinite;
}
.cloud::after{
  content:""; position:absolute; bottom:-10px; left:26px; width:18px; height:18px;
  background:inherit; border:inherit; border-radius:4px 12px 12px 12px; transform:rotate(45deg);
}
.c1{ left:6%;  top:10%;  animation-duration:8.5s; }
.c2{ right:8%; bottom:14%; animation-duration:7s; }
.c3{ left:22%; bottom:10%; width:110px; height:68px; animation-duration:6.5s; }

@keyframes float { 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(-10px) } }

/* responsive */
@media (max-width: 960px){
  .hero{ grid-template-columns: 1fr; min-height: 520px; padding: clamp(22px, 4vw, 36px); }
  .hero-art{ min-height: 280px; }
  .phone{ right: auto; left: 50%; transform: translateX(-50%) perspective(1200px) rotateY(0) rotateX(0); }
}

/* reduced motion */
@media (prefers-reduced-motion: reduce){
  .hero::before, .ring, .phone, .cloud{ animation: none !important; }
}

    .hero h2{margin:0 0 8px}
    .hero p{margin:0;opacity:.9}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .panel h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border)}
    .panel ul{list-style:none;margin:0;padding:8px 0;max-height:360px;overflow:auto}
    .panel li{padding:10px 16px;display:flex;align-items:center;gap:10px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--success)}

    @media (max-width:960px){.app{grid-template-columns:1fr}.main-body{grid-template-columns:1fr}}

    .rooms::-webkit-scrollbar,.panel ul::-webkit-scrollbar{width:10px}
    .rooms::-webkit-scrollbar-thumb,.panel ul::-webkit-scrollbar-thumb{background:var(--border);border-radius:8px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-head">
        {% if user.is_authenticated %}
          <div class="avatar">{{ user.username|slice:":1"|upper }}</div>
          <div>
            <div class="greet">Hello, {{ user.username }}</div>
            <div class="chip"><a href="{% url 'logout' %}">Logout</a></div>
          </div>
        {% else %}
          <div class="avatar">?</div>
          <div>
            <div class="greet"><a href="{% url 'login' %}">Login</a> Â· <a href="{% url 'signup' %}">Sign up</a></div>
            <div class="chip">Welcome</div>
          </div>
        {% endif %}
      </div>

      <div class="search">
        <input type="text" placeholder="Search roomsâ€¦" oninput="filterRooms(this.value)">
      </div>

      <form class="room-form" method="post">{% csrf_token %}
        <input name="name" type="text" placeholder="Create or join room">
        <button class="btn" type="submit">Enter</button>
      </form>

      <ul class="rooms" id="room-list">
        {% for r in rooms %}
          <li>
            <a class="room-item" href="{% url 'room' r.pk %}">
              <div class="avatar" aria-hidden="true">{{ r.name|slice:":1"|upper }}</div>
              <div>
                <div class="rname">{{ r.name }}</div>
              </div>
            </a>
          </li>
        {% empty %}
          <li><div class="room-item"><div class="chip">No rooms yet</div></div></li>
        {% endfor %}
      </ul>
    </aside>

    <main class="main">
      <div class="main-head">
        <div><strong>Messenger</strong> <span class="chip">Home</span></div>
        <div class="chip"><a href="{% url 'index' %}">Refresh</a></div>
      </div>

      <div class="main-body">
       <section class="hero hero-xl" id="hero">
  <div class="hero-copy">
    <h1 class="hero-title">Welcome ðŸ‘‹</h1>
    <p class="hero-subtitle">
      Create or join a room. Real-time messages & presence â€” Telegram-style, fast and clean.
    </p>

    <div class="hero-cta">
      <a class="btn hero-btn" href="#room-list">Browse rooms</a>
      <a class="btn ghost" href="{% url 'index' %}">Refresh</a>
      <span class="pill">âš¡ Live <span id="online-count-hero" class="badge">0</span></span>
      <span class="pill">ðŸŒ“ Auto dark mode</span>
      <span class="pill">ðŸ”’ Secure</span>
    </div>
  </div>

  <!-- decorative phone mock -->
  <div class="hero-art" aria-hidden="true">
    <div class="ring"></div>
    <div class="phone">
      <div class="statusbar"></div>
      <div class="screen">
        <div class="bubble them">Hey! ðŸ‘‹</div>
        <div class="bubble me">Hi! Ready to chat?</div>
        <div class="bubble them">Join Room #12 â€” itâ€™s live now.</div>
        <div class="bubble me">On my way! ðŸš€</div>
      </div>
    </div>
    <div class="cloud c1"></div>
    <div class="cloud c2"></div>
    <div class="cloud c3"></div>
  </div>
</section>


        <section class="panel">
          <h3>All online users <span class="badge" id="online-count">0</span></h3>
          <ul id="online-users"><li style="color:var(--muted); padding:12px 16px">Loadingâ€¦</li></ul>
        </section>
      </div>
    </main>
  </div>

  <script>
    function filterRooms(q){
      q = (q||'').toLowerCase();
      document.querySelectorAll('#room-list .room-item').forEach(a=>{
        const name = a.querySelector('.rname').textContent.toLowerCase();
        a.parentElement.style.display = name.includes(q) ? '' : 'none';
      });
    }

    // Global presence via WS + fallback REST
    (function(){
      const IS_AUTH = '{{ user.is_authenticated|yesno:"true,false" }}' === 'true';
      if (!IS_AUTH){
        document.getElementById('online-users').innerHTML = '<li style="padding:12px 16px; color:var(--muted)">Login to see online users</li>';
        return;
      }
      const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/presence/';
      const sock = new WebSocket(wsURL);
      let every = 20, timer = null;

      function renderFromAPI(){
        fetch('/api/online/')
          .then(r=>r.json())
          .then(d=>{
            const online = Array.isArray(d.online) ? d.online : [];
            const list = online.map(u=>`<li><span class="dot"></span> <span>${u.username}</span></li>`).join('');
            document.getElementById('online-users').innerHTML = list || '<li style="padding:12px 16px; color:var(--muted)">No one online yet</li>';
            const el = document.getElementById('online-count');
            if (el) el.textContent = online.length;
          })
          .catch(()=>{
            document.getElementById('online-users').innerHTML = '<li style="padding:12px 16px; color:var(--muted)">(offline)</li>';
            const el = document.getElementById('online-count');
            if (el) el.textContent = 'â€“';
          });
      }
      function startHB(){
        if (timer) clearInterval(timer);
        timer = setInterval(()=>{ if (sock.readyState === 1) sock.send(JSON.stringify({type:'heartbeat'})); }, every*1000);
      }
      sock.onmessage = e=>{
        const msg = JSON.parse(e.data||'{}');
        if (msg.type === 'all_online'){ every = msg.heartbeat_every || every; startHB(); renderFromAPI(); }
        else if (msg.type === 'presence_event'){ renderFromAPI(); }
      };
      sock.onclose = ()=>{ if (timer) clearInterval(timer); };
    })();
  </script>
</body>
</html>
